// <editor-fold defaultstate="collapsed" desc="Define et configurations">
#include "p24FJ64GA002.h"

_CONFIG1 (JTAGEN_OFF& GCP_OFF &GWRP_OFF& ICS_PGx2& FWDTEN_OFF& WINDIS_OFF)
 _CONFIG2 (0x7987)

#define                               PERIODE1   64000
#define                               PERIODE3   24000

// Commandes du LCD

#define     CLR_DISP          1    // Clear display and set AC to 0x00
#define     RET_HOME          2     // set AC to 0x00
#define     FUNCT_SET         3    // 8bits, 2 lines
#define     FUNCT_SET_4bit    2    // 4bits, 2 lines
#define     LINE_TWO          0xC0 // Cursor move to the second line and set AC to 0x40
#define     MOVE_LEFT         0x10 // Cursor move back one position
#define     MOVE_COLUM_ONE    0x80 // Address counter set zero

#define     INSTRC            0
#define     DATA              1
#define     WRITE             0

//#define                           RELAI         _LATA1   // PIN3
#define                               E             _LATB9   // PIN
#define                               RS            _LATB7  // PIN
#define                               RW            _LATB8  // PIN

#define     LOW         0
#define     HIGH        1


#define DUREE_100us                  2000    // TIMER 1  presacle 8
#define DUREE_1ms                     2000    // TIMER 1  presacle 8
#define DUREE_5ms                     10000   // TIMER 1  presacle 8
#define DUREE_25ms                   50000

#define AdresseMinutes              0x86
#define AdresseSecondes             0x89
#define AdresseDeuxiemeLigne        0xC0

#define UneDemieSeconde                15625
#define UneSeconde                     31250
#define UneSecondeEtDemie           46875
#define DeuxSecondes                62500

#define etapeAttente             0
  // </editor-fold>

// <editor-fold defaultstate="collapsed" desc="Initialisations SFR">
 void InitRPs()
{
    // Unlock registers
    asm volatile ( 	"MOV #OSCCON,W1 \n"
                    "MOV #0x46,W2	\n"
                    "MOV #0x57,W3	\n"
                    "MOV.b W2,[W1]	\n"
                    "MOV.b W3,[W1]	\n"
                    "BCLR OSCCON,#6");

	_RP3R = 3;		// Assign TX to RP3 (0x3) (pin 6)
	_U1RXR = 2;             //Assing Rx to RP2/RB2 (pin 7)

         _RP14R = 18;     //Assing OC1 sur RP14/RB14

    // Lock registers
    asm volatile ( 	"MOV #OSCCON,W1 \n"
                    "MOV #0x46,w2	\n"
                    "MOV #0x57,w3	\n"
                    "MOV.b W2,[W1]	\n"
                    "MOV.b W3,[W1]	\n"
                    "BSET OSCCON,#6");
}

void InitFunct()
{
    AD1PCFG = 0xFFFF;
    TRISA = 0x0000;
    TRISB = 0x0044;

    //CLKDIV = 0;

    T1CON = 0x8010;
    PR1 = PERIODE1;
    _T1IF = 0;
    _T1IP = 1;
    _T1IE = 0;

    T2CON = 0x8030;
    PR2 = 31250;
    _T2IF = 0;
    _T2IP = 4;
    _T2IE = 0;

    T3CON = 0x8020;
    PR3 = 31250;
    _T3IF = 0;
    _T3IP = 3;
    _T3IE = 0;
    // Configuration du port série (UART)
	U1BRG  = 51;
	_U1RXIP = 5;
	U1STA  = 0x2000;	// Interruption à chaque caractère reçu
	U1MODE = 0x8000;
	U1STAbits.UTXEN = 1;
	_U1RXIF = 0;
	_U1RXIE = 0;

        //Configuration des output compare
        OC1CON = 0x0005;
        OC1R = 0;
        OC1RS = 1; //on met 1 us pour que la sotie soit au minimum au début

        //         On set les CN
        CNEN2 = 0x0100;
//on met des pull up sur nos cn utilisées
        CNPU2 = 0x0100;
        _CNIE = 1;
        _CNIF = 0;
        _CNIP = 2;
}
  // </editor-fold>

// <editor-fold defaultstate="collapsed" desc="Fonctions gestion du LCD">
void delay(int periode)
{
   TMR1=0;
   while(TMR1<periode);
}

void lcd_enable(int caract)
{
     LATB=((LATB&0xC3FF)|(caract<<10));//
     E = HIGH;
     asm("repeat #12");// délai 300ns
     asm("nop");
     E = LOW;
}

void Lcd_send(int RegSelect,int caract)
{
      delay(DUREE_1ms);
      RS = RegSelect;
      lcd_enable(caract >> 4);       //Envoie des 4 bits MSB
      lcd_enable(caract & 0x0F);    // Envoie des 4 bits LSB
}

void LCD_Init()
{
    int i;
    int LCD_INIT_STRING[4] = {0x20, 0x0C, 0X01, 0X06};
    RS = INSTRC;
    RW = WRITE;
    E = LOW;


    for(i=1;i<=3;++i)
      {
        lcd_enable(FUNCT_SET);
        delay(DUREE_5ms);
      }

    lcd_enable(FUNCT_SET_4bit);
    delay(DUREE_5ms);

    for(i=0;i<=3;++i)
       Lcd_send(INSTRC,LCD_INIT_STRING[i]);
}

void Lcd_puts(char *buffer)
{
  while(*buffer != '\0')
      {
       Lcd_send(DATA,*buffer++);
      }
}
  // </editor-fold>

unsigned char dizaineMinutesCompteur = 12,uniteMinutesCompteur = 0, dizaineSecondesCompteur = 0,uniteSecondesCompteur;
unsigned char etape = 0, etapeReception = 0, actionDebutDetape=1,messagesMultiples=0;
unsigned int etatDesFils = 0x000E;
unsigned char i = 0,secondesDeBip=0;
unsigned char hex[]={'0','1','2','3','4','5','6','7','8','9','A','B','C','D','E','F'};
unsigned int ancientOCRS1 = 0;

void Envoi( char b)
{
    	while(U1STAbits.UTXBF);
	U1TXREG = b;
}

void AffichageTemps()
{
            Lcd_send(INSTRC,AdresseSecondes+1);
            Lcd_send(DATA,uniteSecondesCompteur+'0');
            Lcd_send(INSTRC,AdresseSecondes);
            Lcd_send(DATA,dizaineSecondesCompteur+'0');
            Lcd_send(INSTRC,AdresseMinutes +1);
            Lcd_send(DATA,uniteMinutesCompteur+'0');
            Lcd_send(INSTRC,AdresseMinutes);
            Lcd_send(DATA,dizaineMinutesCompteur+'0');
            Lcd_send(INSTRC,AdresseSecondes-1);
            Lcd_send(DATA,':');
            if(etape ==1)
            {
                Lcd_send(INSTRC,RET_HOME); //retour home
                //Lcd_send(DATA,0xF8);
                Lcd_puts("BOUTON");
            }


}

void VerificationDesTransitions()
{
    if(etape)
    {
        if((etatDesFils>>(etape-1))&1) 
        {
            ++etape;
            actionDebutDetape = 1;
            secondesDeBip=2;
        }
    }
//    //débugage
//    Lcd_send(INSTRC,RET_HOME);
//    Lcd_send(DATA,hex[(etatDesFils&0xF000)>>12]);
//    Lcd_send(DATA,hex[(etatDesFils&0x0F00)>>8]);
//    Lcd_send(DATA,hex[(etatDesFils&0x00F0)>>4]);
//    Lcd_send(DATA,hex[(etatDesFils&0x000F)]);
}

int main()
{
    InitRPs();
    InitFunct();
  
    delay(DUREE_25ms);

    LCD_Init();
    
    Lcd_puts("Bon courage!");
    _U1RXIE = 1;
    _T2IE = 1;
    _T3IE = 1;
    while (1) {}
}

void __attribute__((__interrupt__,auto_psv)) _U1RXInterrupt(void)
{
    _U1RXIE = 0;
    unsigned char c;
    c = U1RXREG;
    
    switch(etapeReception)
    {
        case 0:
            if(c == 'T')
            {
                ++etapeReception;
                
            }
            break;
        case 1:
            //_RB15=1;
            etatDesFils = 0;
            etatDesFils = etatDesFils|(c<<8);
            ++etapeReception;
            break;
        case 2:
            etatDesFils = etatDesFils|c;
            etapeReception = 0;
            VerificationDesTransitions();
            break;
    }
    _U1RXIE = 1;
    _U1RXIF = 0;
}

void __attribute__((__interrupt__,auto_psv)) _T2Interrupt(void)
{
    unsigned char modifiee =1;
    if(secondesDeBip)
    {
        if(!ancientOCRS1) ancientOCRS1 = OC1RS;
        OC1RS = PR2-1;
        --secondesDeBip;
        if(etape) Lcd_send(INSTRC,CLR_DISP);
        Lcd_send(INSTRC,0x02); //on set le mode d'entré
        Lcd_send(INSTRC,RET_HOME); //retour home
        if(etape) Lcd_puts("!&*(#%~?@$<;3L3?");

        if(!secondesDeBip)
        {
           if(etape) Lcd_send(INSTRC,CLR_DISP);
            Lcd_send(INSTRC,0x02); //on set le mode d'entré
            Lcd_send(INSTRC,RET_HOME); //retour home
            OC1RS =ancientOCRS1;
            _CNIF = 0;
            _CNIF = 1;
            messagesMultiples=0;
            ancientOCRS1=0;
        }
        _T2IF = 0;
    }

    if(etape)
    {
        if(uniteSecondesCompteur>0)
        {
            uniteSecondesCompteur--;
            modifiee = 0;
        }
        if(dizaineSecondesCompteur>0 && modifiee)
        {
            --dizaineSecondesCompteur;
            uniteSecondesCompteur=9;
             modifiee = 0;
        }
        if(uniteMinutesCompteur>0 && modifiee)
        {
            --uniteMinutesCompteur;
            dizaineSecondesCompteur=5;
            uniteSecondesCompteur = 9;
             modifiee = 0;
        }
        if(dizaineMinutesCompteur>0 && modifiee)
        {
            --dizaineMinutesCompteur;
            uniteMinutesCompteur = 9;
            dizaineSecondesCompteur=5;
            uniteSecondesCompteur = 9;
            modifiee = 0;
        }

      if(_RB6)  AffichageTemps();
    }

    _T2IF = 0;
}

void __attribute__((__interrupt__,auto_psv)) _T3Interrupt(void)
{
    _T3IE = 0;
    switch(etape)
    {
        case etapeAttente:
            if(actionDebutDetape)
            {
                actionDebutDetape = 0;
                OC1RS = PR2/3;
                secondesDeBip=10;
            }
            if(_RB6&&!secondesDeBip) ++etape;
            break;
        case 1:
            if(actionDebutDetape)
            {
                actionDebutDetape = 0;
                Lcd_send(INSTRC,CLR_DISP);
                Lcd_send(INSTRC,RET_HOME); //retour home
                Lcd_send(DATA,0xF8);
                Lcd_puts(" BTN");
                VerificationDesTransitions();
                AffichageTemps();
                OC1RS = PR2/2;
            }
            break;
        case 2:
            if(actionDebutDetape)
            {
                actionDebutDetape = 0;
                dizaineMinutesCompteur=4;
                uniteMinutesCompteur = 0;
                dizaineSecondesCompteur = 0;
                uniteSecondesCompteur = 0;
                VerificationDesTransitions();
                AffichageTemps();
                PR2 = UneSecondeEtDemie;
                OC1RS = PR2/2;
            }
            break;
        case 3: 
            if(actionDebutDetape)
            {
                actionDebutDetape = 0;
                VerificationDesTransitions();
                AffichageTemps();
                PR2 = UneDemieSeconde;
                //OC1RS = (PR2/3)*2;
                OC1RS = PR2/2;
            }
            break;
        case 4:  
            if(actionDebutDetape)
            {
                actionDebutDetape = 0;
                --dizaineMinutesCompteur;
                VerificationDesTransitions();
                AffichageTemps();
                PR2 = UneSeconde;
                OC1RS = PR2/2;
            }
        case 5:
            if(actionDebutDetape)
            {
                actionDebutDetape = 0;
                VerificationDesTransitions();
                AffichageTemps();
                PR2 = UneSecondeEtDemie;
                OC1RS = PR2/2;
            }
        case 6:
            if(actionDebutDetape)
            {
                actionDebutDetape = 0;
                VerificationDesTransitions();
                AffichageTemps();
                PR2 = DeuxSecondes;
                OC1RS = PR2/2;
            }
        case 7:
            if(actionDebutDetape)
            {
                actionDebutDetape = 0;
                --dizaineMinutesCompteur;
                VerificationDesTransitions();
                AffichageTemps();
                PR2 = UneSeconde;
                OC1RS = PR2/2;
            }
        case 8:
            if(actionDebutDetape)
            {
                actionDebutDetape = 0;
                uniteMinutesCompteur=9;
                VerificationDesTransitions();
                AffichageTemps();
            }
        case 9:
            if(actionDebutDetape)
            {
                actionDebutDetape = 0;
                VerificationDesTransitions();
                AffichageTemps();
                PR2 = UneSecondeEtDemie;
                OC1RS = PR2/2;
            }
        case 10:
            if(actionDebutDetape)
            {
                actionDebutDetape = 0;
                VerificationDesTransitions();
                AffichageTemps();
                PR2 = UneDemieSeconde;
                //OC1RS = (PR2/3)*2;
                OC1RS = PR2/2;
            }
        case 11:
            if(actionDebutDetape)
            {
                actionDebutDetape = 0;
                dizaineSecondesCompteur = 6;
                VerificationDesTransitions();
                AffichageTemps();
                PR2 = UneSeconde;
                OC1RS = PR2/2;
            }
        case 12:
            if(actionDebutDetape)
            {
                actionDebutDetape = 0;
                VerificationDesTransitions();
                AffichageTemps();
                PR2 = UneDemieSeconde;
//                OC1RS = (PR2/3)*2;
                OC1RS = PR2/2;
            }
        case 13:
            if(actionDebutDetape)
            {
                actionDebutDetape = 0;
                secondesDeBip = 9;
                uniteMinutesCompteur = 0;
                VerificationDesTransitions();
                AffichageTemps();
                OC1RS = PR2/2;
            }
        case 14:
            if(actionDebutDetape)
            {
                actionDebutDetape = 0;
                dizaineMinutesCompteur=0;
                uniteMinutesCompteur = 2;
                dizaineSecondesCompteur = 5;
                uniteSecondesCompteur = 5;
                PR2 = UneSeconde;
                OC1RS = PR2/2;
                VerificationDesTransitions();
                AffichageTemps();
            }
        case 15:
            if(actionDebutDetape)
            {
                actionDebutDetape = 0;
                VerificationDesTransitions();
                AffichageTemps();
                PR2 = UneSeconde;
                OC1RS = PR2/8;
            }
        case 16:
            if(actionDebutDetape)
            {
                actionDebutDetape = 0;
                TMR2=0;
                _T2IE = 0;
                _T2IF = 0;
                OC1RS=1;
                Lcd_send(INSTRC,CLR_DISP);
                Lcd_send(INSTRC,0x02); //on set le mode d'entré
                Lcd_send(INSTRC,RET_HOME); //retour home
                Lcd_puts("BOMBE DESAMORSEE");
            }
            break;
    }
_T3IE = 1;
_T3IF = 0;
}

void __attribute__((__interrupt__,auto_psv)) _CNInterrupt(void)
{

    unsigned char affichee=1;
    unsigned etapeEnEntrant =0;
    etapeEnEntrant = etape;
    if(etape)
    {
        while(!_RB6)
        {
            if(etapeEnEntrant!=etape)
            {
                affichee =1;
                etapeEnEntrant = etape;
            }
            if(affichee)
            {
                // <editor-fold defaultstate="collapsed" desc="Messages">
                Lcd_send(INSTRC,CLR_DISP);
                Lcd_send(INSTRC,0x02); //on set le mode d'entré
                Lcd_send(INSTRC,RET_HOME); //retour home

                switch(etape)
                {
                    case etapeAttente:
                        break;
                    case 1:
                        switch(messagesMultiples)
                        {
                                case 0:
                                    Lcd_puts("ENFIN LE BOUTON");
                                    ++messagesMultiples;
                                    break;
                                case 1:
                                    Lcd_puts("IL ETAIT TEMPS");
                                    ++messagesMultiples;
                                    break;
                                case 2:
                                    Lcd_puts("CEST UNE BOMBE!!");
                                    ++messagesMultiples;
                                    break;
                                case 3:
                                    Lcd_puts("EVIDEMMENT :P");
                                    ++messagesMultiples;
                                    break;
                                case 4:
                                    Lcd_puts("COUPE LE ROUGE!");
                                    ++messagesMultiples;
                                    break;
                                case 5:
                                    Lcd_puts("GROUILE LE ROUGE");
                                    messagesMultiples=0;
                                    break;
                        }
                        break;
                    case 2:
                            Lcd_puts("NUM 10;1;21;14;5");
                            Lcd_send(DATA,hex[etape]);
                        break;
                    case 3:
                            Lcd_puts("EGNARO");
                        break;
                    case 4:
                        switch(messagesMultiples)
                        {
                                case 0:
                                    Lcd_puts("TELEPHONE:");
                                    ++messagesMultiples;
                                    break;
                                case 1:
                                    Lcd_puts("8^3 3^2 7^3 8^1");
                                    messagesMultiples=0;
                                    break;
                        }
                        break;
                    case 5:
                            Lcd_puts("PIECE DE 1 SOUS");
                        break;
                    case 6:
                        switch(messagesMultiples)
                        {
                                case 0:
                                    Lcd_puts("ESPACE _____");
                                    ++messagesMultiples;
                                    break;
                                case 1:
                                    Lcd_puts("_____ DE MEMOIRE");
                                    ++messagesMultiples;
                                    break;
                                case 2:
                                    Lcd_puts("OUBlIE PAS");
                                    ++messagesMultiples;
                                    break;
                                case 3:
                                    Lcd_puts("CEST UNE BOMBE!!");
                                    ++messagesMultiples;
                                    break;
                                case 4:
                                    Lcd_puts("EVIDEMMENT :P");
                                    ++messagesMultiples;
                                    break;
                                case 5:
                                    Lcd_puts("TIC TAC..");
                                    messagesMultiples=0;
                                    break;
                        }
                        break;
                    case 7:
                        switch(messagesMultiples)
                        {
                            case 0:
                                Lcd_puts("LE VERS BLANC");
                                ++messagesMultiples;
                                break;
                            case 1:
                                Lcd_puts("COUPE");
                                ++messagesMultiples;
                                break;
                            case 2:
                                Lcd_puts("LA FEUILLE VERTE");
                                messagesMultiples=0;
                                break;
                        }
                        break;
                    case 8:
                        switch(messagesMultiples)
                        {
                            case 0:
                                Lcd_puts("Mercenaire");
                                ++messagesMultiples;
                                break;
                            case 1:
                                Lcd_puts("Armez");
                                ++messagesMultiples;
                                break;
                            case 2:
                                Lcd_puts("Uniquement");
                                ++messagesMultiples;
                                break;
                            case 3:
                                Lcd_puts("Vos");
                                ++messagesMultiples;
                                break;
                            case 4:
                                Lcd_puts("Ennemis");
                                messagesMultiples=0;
                                break;
                        }
                        break;
                    case 9:
                            Lcd_puts("GANDALF LE ____");
                        break;
                    case 10:
                        switch(messagesMultiples)
                        {
                            case 0:
                                Lcd_puts("LE CIEL D'ETE");
                                ++messagesMultiples;
                                break;
                            case 1:
                                Lcd_puts("PARSEME DE BEAU");
                                ++messagesMultiples;
                                break;
                            case 2:
                                Lcd_puts("CUMULUS");
                                messagesMultiples=0;
                                break;
                        }
                        break;
                    case 11:
                            Lcd_puts("SANS LUMIERE");
                        break;
                    case 12:
                            Lcd_puts("NUM 14;21;18;2");
                        break;
                    case 13:
                         switch(messagesMultiples)
                        {
                            case 0:
                                Lcd_puts("CODE SAMOURAI");
                                ++messagesMultiples;
                                break;
                            case 1:
                                Lcd_puts("1,1;3,3;2,0;5,0;");
                                messagesMultiples=0;
                                break;
                        }
                        break;
                    case 14:
                           switch(messagesMultiples)
                            {
                                case 0:
                                    Lcd_puts("POURQUOI");
                                    ++messagesMultiples;
                                    break;
                               case 1:
                                    Lcd_puts("HESITER ENTRE");
                                    ++messagesMultiples;
                                    break;
                               case 2:
                                    Lcd_puts("TROIS COULEURS?");
                                    ++messagesMultiples;
                                    break;
                               case 3:
                                    Lcd_puts("ALORS QUE SEUL");
                                    ++messagesMultiples;
                                    break;
                               case 4:
                                    Lcd_puts("DEUX COULEURS");
                                    ++messagesMultiples;
                                    break;
                               case 5:
                                    Lcd_puts("IMPORTENT.");
                                    messagesMultiples=0;
                                    break;
                            }
                        break;
                    case 15:
                           switch(messagesMultiples)
                            {
                                case 0:
                                    Lcd_puts("TIC TAC....");
                                    ++messagesMultiples;
                                    break;
                               case 1:
                                    Lcd_puts("GR0UILLE!!");
                                    ++messagesMultiples;
                                    break;
                               case 2:
                                    Lcd_puts("COUPE TOUT!!");
                                    messagesMultiples=0;
                                    break;
                            }
                        break;
                    case 16:
                            Lcd_puts("BOMBE DESAMORSEE");
                            actionDebutDetape = 1;
                        break;
                }
                  // </editor-fold>
                affichee=0;
            }
        }
    }
    
    Lcd_send(INSTRC,CLR_DISP);
    Lcd_send(INSTRC,RET_HOME); //retour home
    AffichageTemps();

    _CNIF = 0;
}
